<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://connect-cdn.atl-paas.net/all.js" crossorigin="anonymous" ></script>
<script>
async function manual() {
  var token = document.getElementById("jwt").value;
  var body = {
  "expand": [
    "names",
    "schema",
    "operations"
  ],
  "fields": [
    "summary",
    "status",
    "assignee"
  ],
  "fieldsByKeys": false,
  "jql": "",
  "maxResults": 15,
  "startAt": 0
};
 try {
    const response = await fetch("https://gtola.atlassian.net/rest/api/2/search", {
      method: "POST",
      mode: "no-cors",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        'Authorization': 'JWT '+token
      },
      body: JSON.stringify({}),
    });

    const result = await response.json();
    console.log("GT Success:", result);
  } catch (error) {
    console.error("GT Error:", error);
  }
  

}

function paginate(path, startAt, result, onDoneCallback) {
  AP.request({
    url: path+(path.includes('?') ? '&' : '?')  +'startAt='+startAt+'&maxResults=2',
    type: 'GET',
    contentType: 'application/json',
    headers: { Accept: 'application/json' },
    success: function(responseText){
      var items = JSON.parse(responseText).values;
      if(items.length>0) {
        result = result.concat(items);
        paginate(path, startAt+items.length, result);
      } else {
        onDoneCallback(result);
      }
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      console.log("err: "+errorThrown);
    }
  });
}


function statuses() {
  paginate('/rest/api/3/statuses/search?projectId=10000',0,[],function(data){
    debugger;
  });


<!-- AP.request({ -->
    <!-- url: '/rest/api/3/statuses/search?startAt=0&maxResults=100&projectId=10000', -->
    <!-- type: 'GET', -->
    <!-- contentType: 'application/json', -->
    <!-- headers: { Accept: 'application/json' }, -->
    <!-- success: function(responseText){ -->
      <!-- console.log("success:"+responseText); -->
    <!-- }, -->
    <!-- error: function(xhr, statusText, errorThrown){ -->
      <!-- console.log("err: "+errorThrown); -->
    <!-- } -->
  <!-- }); -->

}

function GT(startAt) {
  if(!startAt) {
    startAt = { i:900 };
    for(var i =0;i<10*100; i++)
      AP.request({url: '/rest/api/3/search?fields=key,project,status&expand=transitions,changelog&startAt='+(i*100)+'&maxResults=100', type: 'GET', success: function(responseText){ console.log("GT res: "+ responseText); let data = JSON.parse(responseText); GT(startAt.i=startAt.i+1); }, error: function(xhr, statusText, errorThrown){ console.log("GT: Error while getting issue details: "+JSON.stringify(arguments)); }});
  } else {
    AP.request({url: '/rest/api/3/search?fields=key,project,status&expand=transitions,changelog&startAt='+(startAt.i*100)+'&maxResults=100', type: 'GET', success: function(responseText){ console.log("GT res: "+ responseText); let data = JSON.parse(responseText); GT(startAt.i=startAt.i+1); }, error: function(xhr, statusText, errorThrown){ console.log("GT: Error while getting issue details: "+JSON.stringify(arguments)); }});  
  }
}

function createCustomField() {
  AP.request({
    url: '/rest/api/3/field',
    type: 'POST',
    contentType: 'application/json',
    headers: { Accept: 'application/json' },
    data: JSON.stringify({
      "description": "Custom field for picking groups",
      "name": "New custom field",
      "searcherKey": "com.atlassian.jira.plugin.system.customfieldtypes:grouppickersearcher",
      "type": "com.atlassian.jira.plugin.system.customfieldtypes:grouppicker"
    }),
    success: function(responseText){
      alert("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      alert("err: "+errorThrown);
    }
  });
}

var startAt=10;
var retryCount=0;
var retryAfterMiliseconds = 100000;
function GT3() {
  for(var i=0;i<startAt;i++)
    GT4(i);
}
var started=0;
var finished=0;
function GT4(i) {
  started++;
  var tmp = startAt;
  if(i)
    tmp = i;
  var tmpUrl = '/rest/api/3/search?fields=key,project,status,created&expand=transitions,changelog&startAt='+(tmp*100)+'&maxResults=100';
  console.log(tmpUrl);
  AP.request({url: tmpUrl, type: 'GET', success: function(responseText){
    finished++;
    //console.log("GT res: "+ responseText);
    let data = JSON.parse(responseText);
    for(var j=0;j<data.issues.length;j++)
      calculate(data.issues[j]);
    if(data.issues.length===0) {
      setTimeout(printStatuses(),3000);
      return;
    }
    startAt++;
    if(started-finished>10)
      console.log("GT threads exceeded");
    else
      GT4();
  }, error: function(xhr, statusText, errorThrown){ 
    finished++;
   // console.log("GT: Error while getting issue details: "+JSON.stringify(arguments)); 
    console.log("GT:retry");
    if(retryCount++<4000000)
      setTimeout(GT4(),retryAfterMiliseconds,startAt-1);
  }});   
}

function printStatuses() {
  var possibleKeys = {};
  Object.keys(TIMES).forEach(function (key) {
   possibleKeys[key]=1;
  });
  var output = "";
  Object.keys(possibleKeys).forEach(function (key) {
   output = key+",";
  });
  alert(output);
}

var TIMES={};
function calculate(DATA) { 
  let metric = 1000 * 60;
  
  let tmpDate = new Date(DATA.fields.created);
  let tmpCardId = DATA.key;
  let tmpList = DATA.transitions[0].name;
  
  //debugger;
  
  let startFrom = DATA.changelog.histories.length-1;
  let moved = false;
  let prevStatusAfterMove=null;
  for(let i=0;i<DATA.changelog.histories.length && !moved;i++) {
    for(let j=0;j<DATA.changelog.histories[i].items.length;j++) {
      if(DATA.changelog.histories[i].items[j].field==="status") {
        prevStatusAfterMove = DATA.changelog.histories[i].items[j].fromString;
      } else if(DATA.changelog.histories[i].items[j].field==="project") {
        tmpList=prevStatusAfterMove ? prevStatusAfterMove : DATA.fields.status.name;
        tmpDate= new Date(DATA.changelog.histories[i].created);
        startFrom = i;
        moved=true;
        break;
      }
    }
  }
  
  TIMES[tmpCardId] = {};
  TIMES[tmpCardId]['currentList']=tmpList;
  TIMES[tmpCardId][tmpList] = {};
  TIMES[tmpCardId][tmpList]['from']=tmpDate;
  TIMES[tmpCardId][tmpList]['time']=0;
  
  for(let i=startFrom; i>=0; i--) {  
    for(let j=0;j<DATA.changelog.histories[i].items.length;j++)
      if(DATA.changelog.histories[i].items[j].field==="status") {
        tmpDate = new Date(DATA.changelog.histories[i].created);
        let tmpListBefore = DATA.changelog.histories[i].items[DATA.changelog.histories[i].items.length-1].fromString;
        let tmpListAfter = DATA.changelog.histories[i].items[DATA.changelog.histories[i].items.length-1].toString;    
        TIMES[tmpCardId]['currentList']=tmpListAfter;     
        if(TIMES[tmpCardId][tmpListBefore])
          TIMES[tmpCardId][tmpListBefore]['time'] += (tmpDate-TIMES[tmpCardId][tmpListBefore]['from'])/metric;
        if(!TIMES[tmpCardId][tmpListAfter])
          TIMES[tmpCardId][tmpListAfter] = { time: 0};
        TIMES[tmpCardId][tmpListAfter]['from'] = tmpDate;
      }
  }
  
  Object.keys(TIMES).forEach(function (key) {
    let now = new Date();
    TIMES[key][ TIMES[key]['currentList'] ]['time']+=(now-TIMES[key][ TIMES[key]['currentList'] ]['from'])/metric;
  });
}
</script>
</head>
<body>
<h1>CONFIG<h1>
<input type="text" id="jwt"></input>
<button onclick="statuses()">GoGOGOGOGOOGOG</button>
<p id="gtolaResult"></p>
</body>
</html>