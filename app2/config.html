<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://connect-cdn.atl-paas.net/all.js" crossorigin="anonymous" ></script>
<script>

var requestCounter={};
var AP2 = { 
  request: function(params){
    if(params.url.includes('/rest/api/3/search?fields=key,project,status,created&expand=transitions,changelog')) {
      if(requestCounter['/rest/api/3/search?fields=key,project,status,created&expand=transitions,changelog']) {
        params.success( '{ "issues": [ ] }' );
      } else {
        requestCounter['/rest/api/3/search?fields=key,project,status,created&expand=transitions,changelog']=true;
        params.success( '{"issues": [{"id": 1,"c1":"","fields":{"created":"2023-01-06T22:27:47.163+0200"},"transitions": [{"name": "To Do"}],"changelog": {"histories": [{"created": "2023-05-06T22:27:47.163+0200","items": [{"field": "Status","fromString": "To Do","toString": "Done"}]}]}}]}' );
      }
    }///rest/api/3/field/search?type=custom&query=Duration
    else if(params.url.includes('/rest/api/3/field/search?type=custom&query=Duration')) {
      if(requestCounter['/rest/api/3/field/search?type=custom&query=Duration']) {
        params.success( '{ "values": [ ] }' );
      } else {
        requestCounter['/rest/api/3/field/search?type=custom&query=Duration']=true;
        params.success( '{"values": [{"id": 1,"name":"Duration in DOING"}]}' );
      }
    }
    else if(params.url.includes('field/search')) {
      if(requestCounter['field/search']) {
        params.success( '{ "values": [ ] }' );
      } else {
        requestCounter['field/search']=true;
        params.success( '{"values": [{"id": "c1","name":"Custom1"}]}' );
      }
    }///rest/api/3/field
    else if(params.url.includes('/api/3/field')) {
        params.success( '{"id":"c2","name":"C2"}' );
    }///rest/api/3/screens
    else if(params.url.includes('rest/api/3/screens')) {
      if(requestCounter['rest/api/3/screens']) {
        params.success( '{ "values": [ ] }' );
      } else {
        requestCounter['rest/api/3/screens']=true;
        params.success( '{"values": [{"id": "s1","name":"screen1"}]}' );
      }
    }
    else if(params.url.includes('/tabs')) {
        params.success( '{"id":"t2","name":"tab 2"}' );
    }
    else if(params.url.includes('/rest/api/3/issue/')) {
        params.success( '{"id":"t2","name":"tab 2"}' );
    }
  }
};

function main() {
  testUpdate();

  function testUpdate() {
    var data = [{ url: '/rest/api/3/issue/PROJ-9461', postData: JSON.stringify({fields:{customfield_10433:243418987.476}})},{ url: '/rest/api/3/issue/PROJ-9461', postData: JSON.stringify({fields:{customfield_10433:243418987.476}})}];
    bulk(data, 'PUT',1, function(argument) {
      //done
      doneCallback();
    }, function(argument, argument2) {
      //response
      
    });
    
  }
  
  return;
  
  //1. GET ISSUES and CALCULATE
  getIssues(function(getIssuesResult) {   
    //2 FIND ALL STATUSES AND CHECK IF ANY CUSTOM FIELD IS MISSING 
    getMissingCustomFields(getIssuesResult,function(getIssuesResult, missingCustomFieldsResult) {
      //3. CREATE MISSING CUSTOM FIELDS   
      createCustomFields(getIssuesResult, missingCustomFieldsResult, function(getIssuesResult) {
        //4. ADD CUSTOM FIELDS TO SCREENS
        addCustomFieldsToScreenTabs(getIssuesResult,function(){
            //5. UPDATE ISSUES
            updateIssues(getIssuesResult, function(){
              console.log('done');
            });
        });
      });
    });
    
  });

  //6. REMOVE CUSTOM FIELDS FROM SCREENS

  function updateIssues(getIssuesResult, doneCallback) {
    var inTimesKeys = Object.keys(getIssuesResult.times);
    var urlsAndPostDatas = [];
    for(var i=0;i<inTimesKeys.length;i++) {
      var issueKey=inTimesKeys[i];
      var postCustomfieldData = {};
      postCustomfieldData['fields']={};
      
      var times = Object.keys(getIssuesResult.times[issueKey]);
      for(var j=0;j<times.length;j++) {
        var tmpStatus = times[j];
        if(tmpStatus!=='currentList')
          postCustomfieldData['fields'][getIssuesResult.existingCustomFields['Duration In '+tmpStatus]]=parseFloat(getIssuesResult.times[issueKey][tmpStatus].time.toFixed(3));      }
    
      urlsAndPostDatas.push({ url: '/rest/api/3/issue/'+issueKey, postData: JSON.stringify(postCustomfieldData)});
    }
    bulk(urlsAndPostDatas, 'PUT',1, function(argument) {
      //done
      doneCallback();
    }, function(argument, argument2) {
      //response
      
    });
    
  }


  function getIssues(doneCallback) {
    var result = { times: {}, existingCustomFields: {}};//&jql=project=PROJ2
    doGetMultithread('/rest/api/3/search?fields=key,project,status,created&expand=transitions,changelog&maxResults=100','issues', 10, 
    function(data) {
      for(var j=0;j<data.issues.length;j++)
        calculate(data.issues[j],result.times,result.existingCustomFields);
    }
    , function() {
      doneCallback(result);
    });
  }

  function getMissingCustomFields(getIssuesResult, doneCallback) {
    var allFields = {};
    var missing = [];
    doGetMultithread('/rest/api/3/field/search?type=custom&query=Duration%20In%20&maxResults=100','values', 3, 
      function(data) {
        for(var j=0;j<data.values.length;j++)
          allFields[data.values[j].name]=data.values[j].id;
      }
    , function() {
      var missingCustomFieds = {};
      var inTimesKeys = Object.keys(getIssuesResult.existingCustomFields);
      for(var i=0;i<inTimesKeys.length;i++) {
        if(!allFields[getIssuesResult.existingCustomFields[inTimesKeys[i]]])
          missing.push(inTimesKeys[i]);
        else
          getIssuesResult.existingCustomFields[inTimesKeys[i]]=allFields[getIssuesResult.existingCustomFields[inTimesKeys[i]]];
      }
      doneCallback(getIssuesResult,missing);
    });
  }

  function createCustomFields(getIssuesResult, customFieldsArray, callback) {
    var urlsAndPostDatas = [];
    for(var i=0;i<customFieldsArray.length;i++) {
      var tmpPostData = JSON.stringify({
        "description": customFieldsArray[i] +' Status',
        "name": customFieldsArray[i],
        "searcherKey": "com.atlassian.jira.plugin.system.customfieldtypes:numberrange",
        "type": "com.atlassian.jira.plugin.system.customfieldtypes:float"
      });
      urlsAndPostDatas.push({ url: '/rest/api/3/field', postData: tmpPostData});
    }


    bulk(urlsAndPostDatas, 'POST',10, function(argument) {
      //done
      callback(getIssuesResult);
    }, function(argument, argument2) {
      //response
      getIssuesResult.existingCustomFields[customFieldsArray[argument2]]=argument.id;
    });
  }

  function addCustomFieldsToScreenTabs(getIssuesResult, callback) {
    var screens = [];
    doGetMultithread('/rest/api/3/screens?maxResults=100','values', 10, 
      function(data) {
        for(var i=0;i<data.values.length;i++)
          screens.push(data.values[i].id);
      }
    , function() {
      var tabs = [];
      var urlsAndPostDatas = [];
      for(var i=0;i<screens.length;i++)
        urlsAndPostDatas.push({ url: '/rest/api/2/screens/'+screens[i]+'/tabs', postData: null});
      
      bulk(urlsAndPostDatas, 'GET',10, function(argument) {
        
        var tabsPostDatas = [];
        
        var inTimesKeys = Object.keys(getIssuesResult.existingCustomFields);
        var customFieldIds=[];
        for(var i=0;i<inTimesKeys.length;i++) 
          customFieldIds.push(getIssuesResult.existingCustomFields[inTimesKeys[i]]);
        
        for(var i=0;i<tabs.length;i++) {
          for(var j=0;j<customFieldIds.length;j++) {
            var postData = {};
            postData['fieldId']=customFieldIds[j];
            tabsPostDatas.push({ url: '/rest/api/2/screens/'+tabs[i].screen+'/tabs/'+tabs[i].tab+'/fields', postData: JSON.stringify(postData)});
          }
        }
        bulk(tabsPostDatas, 'POST',10, function(argument) {
          //done
          callback();
        }, function(argument) {

        });
        
      }, function(argument,argument2) {
        //response
        for(var k=0;k<argument.length;k++)
          tabs.push({"tab":argument[k].id, "screen":screens[argument2]});
      });
    });
  }

  function bulk(urlsAndPostDatas, method,threads, doneCallback, responseCallback) {
    run(urlsAndPostDatas, method,threads, doneCallback, responseCallback);

    function run(urlsAndPostDatas, method,threads, doneCallback, responseCallback) {
        var total = urlsAndPostDatas.length;
        var itemsPerThread = Math.floor( total/threads );

        if(threads>=total) {
            itemsPerThread=1;
            threads=total;
        }

        var done = [];
        for(var i=0;i<threads;i++)
            done.push(false);
        for(var i=0;i<threads;i++)
            nea1(i,i*itemsPerThread,i===threads-1 ? total : i*itemsPerThread+itemsPerThread,function(argg) { done[argg]=true; check1(done,doneCallback); },
               urlsAndPostDatas,method, responseCallback);
    }

    function check1(done,callback) {
        for(var j=0;j<done.length;j++)
            if(!done[j])
                return;
         callback();
    }

    function nea1(ii, tmpUrl, max, callback, urlsAndPostDatas, method,responseCallback) {
       if(tmpUrl>=max){
           callback(ii);
       } else {
        if(!urlsAndPostDatas[tmpUrl])
          console.log('here');
         AP.request({url: urlsAndPostDatas[tmpUrl].url, type: method, data: urlsAndPostDatas[tmpUrl].postData, contentType: 'application/json', headers: { Accept: 'application/json' }, success: function(data){    
           console.log(urlsAndPostDatas[tmpUrl].url);
           responseCallback(JSON.parse(data),tmpUrl);
           nea1(ii, tmpUrl+1,max,callback,urlsAndPostDatas,method, responseCallback);
        }, error: function(xhr, statusText, errorThrown){  
           console.log("GT:retry " +tmpUrl );
           if(retryCount++<4000000)
               nea1(ii, tmpUrl, max, callback,urlsAndPostDatas,method, responseCallback);
        } }); 
      }
    }

  }

  function doGetMultithread(paramUrl, paramXpath, threads, responseCallback, doneCallback) {
    var sharedStart=0;
    var sharedDone=false;
    var sharedStarted=0;
    var sharedFinished=0;
    var xpath="";
    var url="";
    var doneCalled=false;

    run(threads,doneCallback);

    function run(threads, doneCallback){   
      sharedStart=threads;
      sharedDone=false;
      sharedStarted=0;
      sharedFinished=0;
      url=paramUrl;
      xpath=paramXpath;

      for(var i=0;i<sharedStart;)
        nea(i++, function() { doneCallback(); } );
    }

    function nea(tmpUrl, doneCallback, retry) {
       if(sharedDone && sharedFinished===sharedStarted && !retry){
          if(!doneCalled) {
            doneCalled=true;
           doneCallback();
         }
       } else {
         if(!sharedDone || retry) {
          sharedStarted++;
          AP.request({url: url+'&startAt='+(tmpUrl*100), type: 'GET', success: function(responseText){    
             let data = JSON.parse(responseText);
             if(data[xpath].length===0) 
              sharedDone=true;
             sharedFinished++;
             console.log(url+'&startAt='+(tmpUrl*100));
             
             responseCallback(data);
             
             nea(sharedStart++,doneCallback);
          }, error: function(xhr, statusText, errorThrown){  
            sharedFinished++;
             console.log("GT:retry " +tmpUrl );
             if(retryCount++<4000000)
                 nea(tmpUrl,doneCallback, true);
          } });	
        }
      }
    }
  }
}


























function test1(){
 // paginate('/rest/api/2/screenscheme', 0, [], function(data){
  
    createCustomField("GT2", function(field){
  
    
    
  
  
    var data = [ { 'screens': { 'default': 10002} }, { 'screens': { 'default': 10003} } ]
    for(var i=0;i<data.length;i++) {
      var screenId = data[i].screens.default;
      AP.request({url: '/rest/api/2/screens/'+screenId+'/tabs', type: 'GET', headers: { Accept: 'application/json' },
        success: function(tabsText){
          var tabsData = JSON.parse(tabsText);
          console.log("success:"+tabsText);
          
          var customFieldId=field.id;//'customfield_10071';
          var postData = {};
          postData['fieldId']=customFieldId;
          
          var issueKey='PROJ2-2';
          var postCustomfieldData = {};
          postCustomfieldData['fields']={};
          postCustomfieldData['fields'][customFieldId]=1.234;
          
          for(var j=0;j<tabsData.length; j++) {
            AP.request({url: '/rest/api/2/screens/'+screenId+'/tabs/'+tabsData[j].id+'/fields', type: 'POST', contentType: 'application/json', headers: { Accept: 'application/json' },data: JSON.stringify(postData),
              success: function(addTotabText){
                var addTotabsData = JSON.parse(addTotabText);
                console.log("success:"+addTotabText);
               
                //addFieldToDefaultScreen(customFieldId,function() {              })
                
                var issueKey='10000';
                var postCustomfieldData = {};
                postCustomfieldData['fields']={};
                postCustomfieldData['fields'][customFieldId]=1.234;
                
                AP.request({
                  url: '/rest/api/3/issue/'+issueKey,
                  type: 'PUT',
                  contentType: 'application/json',
                  headers: { Accept: 'application/json' },
                  data: JSON.stringify(postCustomfieldData),
                  success: function(responseText){
                    console.log("success:"+responseText);
                  },
                  error: function(xhr, statusText, errorThrown){
                    console.log("err: "+errorThrown);
                  }
                });
                
                
              },
              error: function(xhr, statusText, errorThrown){
                console.log("err: "+errorThrown);
                
                AP.request({
                  url: '/rest/api/3/issue/'+issueKey,
                  type: 'PUT',
                  contentType: 'application/json',
                  headers: { Accept: 'application/json' },
                  data: JSON.stringify(postCustomfieldData),
                  success: function(responseText){
                    console.log("success:"+responseText);
                  },
                  error: function(xhr, statusText, errorThrown){
                    console.log("err: "+errorThrown);
                  }
                });
                
                
              }
            });
          }
          
        },
        error: function(xhr, statusText, errorThrown){
          console.log("err: "+errorThrown);
        }
      });
    
    }
  
  
  });
  //});



  return;

  AP.request({url: '/rest/api/2/screens', type: 'GET', headers: { Accept: 'application/json' },
    success: function(screensText){
      var screensData = JSON.parse(screensText);
      console.log("success:"+screensText);
      

      
    },
    error: function(xhr, statusText, errorThrown){
      console.log("err: "+errorThrown);
    }
  });
}

function addFieldToTab(fieldId,callback) {
  AP.request({
    url: '/rest/api/2/screens/{screenId}/tabs/{tabId}/fields',
    type: 'POST',
    headers: { Accept: 'application/json' },
    success: function(responseText){
      callback(JSON.parse(responseText));
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      callback();
      console.log("err: "+errorThrown);
    }
  });
}

function paginate(path, startAt, result, onDoneCallback) {
  AP.request({
    url: path+(path.includes('?') ? '&' : '?')  +'startAt='+startAt+'&maxResults=200',
    type: 'GET',
    contentType: 'application/json',
    headers: { Accept: 'application/json' },
    success: function(responseText){
      var items = JSON.parse(responseText).values;
      if(items.length>0) {
        result = result.concat(items);
        paginate(path, startAt+items.length, result, onDoneCallback);
      } else {
        onDoneCallback(result);
      }
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      console.log("err: "+errorThrown);
    }
  });
}


function statuses() {
  // paginate('/rest/api/3/screens?queryString=GTOLA',0,[],function(screensData){
  //   if(screensData.values.length===0) {
  //     createScreen(function(createScreenData){
  //       var screenId = createScreenData.id;

        paginate('/rest/api/3/field/search?type=custom&query=Duration%20In%20',0,[],function(data){
            var customFields = {};
            if(data.values.length>0) {
              for(var i=0;i<data.values.length; i++) {
                customFields[data.values[i].name]=data.values[i].id;
                addFieldToDefaultScreen(data.values[i].id);
              }
            } else {
              paginate('/rest/api/3/statuses/search?projectId=10000',0,[],function(data){
                for(var i=0;i<data.length; i++)
                  createCustomField('Duration In '+data[i].name, function(arg1) {
                    customFields[arg1.name]=arg1.id;
                    addFieldToDefaultScreen(arg1.id);
                  });
              });
            }
            
          for(var i=0;i<startAt;i++)
            GT4(i, function(){
              var possibleKeys = {};
              Object.keys(TIMES).forEach(function (key) {
                Object.keys(TIMES[key]).forEach(function (key2) {
                  if(!key2!=='currentList')
                    possibleKeys[key2]=1;
                });
              });
              Object.keys(possibleKeys).forEach(function (key) {
                if(!customFields['Duration In '+key])
                  createCustomField('Duration In '+key, function(arg1) {
                    customFields[arg1.name]=arg1.id;
                  });
              });

              var first=true;
              Object.keys(TIMES).forEach(function (key) {
                if(!first)
                  return;
                first=false;
                var postData = {};
                postData["fields"]={};
                Object.keys(TIMES[key]).forEach(function (key2) {
                  if(key2!=='currentList') {
                    postData["fields"][customFields['Duration In '+key2]]=TIMES[key][key2].time.toFixed(2);
                    addFieldToDefaultScreen(customFields['Duration In '+key2],function() {

                      AP.request({
                        url: '/rest/api/3/issue/'+key,
                        type: 'PUT',
                        contentType: 'application/json',
                        headers: { Accept: 'application/json' },
                        data: JSON.stringify(postData),
                        success: function(responseText){
                          console.log("success:"+responseText);
                        },
                        error: function(xhr, statusText, errorThrown){
                          console.log("err: "+errorThrown);
                        }
                      });

                    })
                  }
                });
                



              });
         
              

            });
            
            
            
          });


  //     });
  //   }
  // });
}

function GT(startAt) {
  if(!startAt) {
    startAt = { i:900 };
    for(var i =0;i<10*100; i++)
      AP.request({url: '/rest/api/3/search?fields=key,project,status&expand=transitions,changelog&startAt='+(i*100)+'&maxResults=100', type: 'GET', success: function(responseText){ console.log("GT res: "+ responseText); let data = JSON.parse(responseText); GT(startAt.i=startAt.i+1); }, error: function(xhr, statusText, errorThrown){ console.log("GT: Error while getting issue details: "+JSON.stringify(arguments)); }});
  } else {
    AP.request({url: '/rest/api/3/search?fields=key,project,status&expand=transitions,changelog&startAt='+(startAt.i*100)+'&maxResults=100', type: 'GET', success: function(responseText){ console.log("GT res: "+ responseText); let data = JSON.parse(responseText); GT(startAt.i=startAt.i+1); }, error: function(xhr, statusText, errorThrown){ console.log("GT: Error while getting issue details: "+JSON.stringify(arguments)); }});  
  }
}

function createCustomField(statusName, callback) {
  AP.request({
    url: '/rest/api/3/field',
    type: 'POST',
    contentType: 'application/json',
    headers: { Accept: 'application/json' },
    data: JSON.stringify({
      "description": statusName +' Status',
      "name": statusName,
      "searcherKey": "com.atlassian.jira.plugin.system.customfieldtypes:numberrange",
      "type": "com.atlassian.jira.plugin.system.customfieldtypes:float"
    }),
    success: function(responseText){
      callback(JSON.parse(responseText));
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      console.log("err: "+errorThrown);
    }
  });
}

function createScreen(callback) {
  AP.request({
    url: '/rest/api/3/screens',
    type: 'POST',
    contentType: 'application/json',
    headers: { Accept: 'application/json' },
    data: JSON.stringify(      {
        "description": "GTOLA",
        "name": "GTOLA"
      }),
    success: function(responseText){
      callback(JSON.parse(responseText));
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      console.log("err: "+errorThrown);
    }
  });
}

function addFieldToDefaultScreen(fieldId,callback) {
  AP.request({
    url: '/rest/api/3/screens/addToDefault/'+fieldId,
    type: 'POST',
    headers: { Accept: 'application/json' },
    success: function(responseText){
      callback(JSON.parse(responseText));
      console.log("success:"+responseText);
    },
    error: function(xhr, statusText, errorThrown){
      callback();
      console.log("err: "+errorThrown);
    }
  });
}

function printStatuses() {
  var possibleKeys = {};
  Object.keys(TIMES).forEach(function (key) {
   possibleKeys[key]=1;
  });
  var output = "";
  Object.keys(possibleKeys).forEach(function (key) {
   output = key+",";
  });
  alert(output);
}


function calculate(DATA,TIMES,CUSTOM_FIELDS_IN_TIMES) { 
  let metric = 1000 * 60;
  
  let tmpDate = new Date(DATA.fields.created);
  let tmpCardId = DATA.key;
  let tmpList = DATA.transitions[0].name;
  
  //debugger;
  
  let startFrom = DATA.changelog.histories.length-1;
  let moved = false;
  let prevStatusAfterMove=null;
  for(let i=0;i<DATA.changelog.histories.length && !moved;i++) {
    for(let j=0;j<DATA.changelog.histories[i].items.length;j++) {
      if(DATA.changelog.histories[i].items[j].field==="status") {
        prevStatusAfterMove = DATA.changelog.histories[i].items[j].fromString;
      } else if(DATA.changelog.histories[i].items[j].field==="project") {
        tmpList=prevStatusAfterMove ? prevStatusAfterMove : DATA.fields.status.name;
        tmpDate= new Date(DATA.changelog.histories[i].created);
        startFrom = i;
        moved=true;
        break;
      }
    }
  }
  
  TIMES[tmpCardId] = {};
  TIMES[tmpCardId]['currentList']=tmpList;
  TIMES[tmpCardId][tmpList] = {};
  TIMES[tmpCardId][tmpList]['from']=tmpDate;
  TIMES[tmpCardId][tmpList]['time']=0;
  
  CUSTOM_FIELDS_IN_TIMES['Duration In ' + tmpList]="";
  
  for(let i=startFrom; i>=0; i--) {  
    for(let j=0;j<DATA.changelog.histories[i].items.length;j++)
      if(DATA.changelog.histories[i].items[j].field==="status") {
        tmpDate = new Date(DATA.changelog.histories[i].created);
        let tmpListBefore = DATA.changelog.histories[i].items[DATA.changelog.histories[i].items.length-1].fromString;
        let tmpListAfter = DATA.changelog.histories[i].items[DATA.changelog.histories[i].items.length-1].toString;    
        
        CUSTOM_FIELDS_IN_TIMES['Duration In ' + tmpListBefore]="";
        CUSTOM_FIELDS_IN_TIMES['Duration In ' + tmpListAfter]="";
        
        TIMES[tmpCardId]['currentList']=tmpListAfter;     
        if(TIMES[tmpCardId][tmpListBefore])
          TIMES[tmpCardId][tmpListBefore]['time'] += (tmpDate-TIMES[tmpCardId][tmpListBefore]['from'])/metric;
        if(!TIMES[tmpCardId][tmpListAfter])
          TIMES[tmpCardId][tmpListAfter] = { time: 0};
        TIMES[tmpCardId][tmpListAfter]['from'] = tmpDate;
      }
  }
  
  var timesCounter=0;
  var keys = Object.keys(TIMES);
  for(var i=0;i<keys.length;i++) {
    var key = keys[i];
    let now = new Date();
    TIMES[key][ TIMES[key]['currentList'] ]['time']+=(now-TIMES[key][ TIMES[key]['currentList'] ]['from'])/metric;
    timesCounter++;
  }
}
</script>
</head>
<body>
<h1>CONFIG<h1>
<input type="text" id="jwt"></input>
<button onclick="main()">GoGOGOGOGOOGOG</button>
<p id="gtolaResult"></p>
</body>
</html>